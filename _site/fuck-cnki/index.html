<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>在中国知网下载 PDF 格式的学位论文</title>

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://blog.szm.me/fuck-cnki/">
</head>
<body>
    <header class="header">
    <div class="wrapper">
        <div class="homelink-wrapper">
            <a href="/" class="homelink">
                <strong>Song Ziming's Blog</strong>
            </a>
        </div>
        
        <nav class="nav">
        
            <a href="/archives" class="nav-link">archives</a>
        
            <a href="/about" class="nav-link">about</a>
        
            <a href="https://github.com/songziming/blog" class="nav-link">source</a>
        
        </nav>
    </div>
</header>

    <main class="wrapper">
        <article class="article-block">
    <header class="article-header">
        <h1>在中国知网下载 PDF 格式的学位论文</h1>
        <p class="article-meta">
            <time datetime="2016-02-24T00:00:00+08:00" itemprop="datePublished">2016-02-24</time>
            
                /
                
                    工具
                
            
        </p>
    </header>
    <main class="article-content">
        <p>因为要写毕设论文，需要查阅许多知网上的学位论文。而中国知网奇怪的地方在于，放着成熟的 PDF 规范不用，非要自己搞出一个封闭的 CAJ 格式，学位论文还不提供 PDF 的格式，逼着人们只能去下载它们的 CAJViewer，最不可忍受的是竟然没有 Linux 下的版本！</p>

<p>但是群众的智慧是无穷的，最近发现，通过一个 UserScript 就可以给学位论文页面加上“PDF 下载”的按钮。</p>

<p>所谓 UserScript，就是一个浏览器插件，能够动态地修改页面内容。在 Chrome 浏览器中，需要安装 Tampermonkey 插件来管理 UserScripts，FireFox 中可以使用 Greasemonkey。</p>

<p>脚本的内容可以从<a href="http://userscripts-mirror.org/scripts/show/164338">这里</a>获取。原本的域名是 <code>userscripts.org</code>，但这个网站似乎挂了很久了，不过镜像站 <code>userscripts-mirror.org</code> 一直可用。</p>

<h3>代码</h3>

<p>为了保险，将脚本完整内容复制在此：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// ==UserScript==</span>
<span class="c1">// @id             CNKI-PDF-Special</span>
<span class="c1">// @name           CNKI 中国知网 PDF 全文下载(特制版)</span>
<span class="c1">// @version        1.25</span>
<span class="c1">// @namespace      http://yuelong.info</span>
<span class="c1">// @author         YUE Long</span>
<span class="c1">// @updateURL      https://userscripts.org/scripts/source/164338.meta.js</span>
<span class="c1">// @description    ① 点击 CNKI 检索结果界面中的下载按钮可以直接下载 PDF 格式文献；</span>
<span class="c1">//                 ② 在硕士/博士学位论文详细信息界面添加“PDF下载”按钮。</span>
<span class="c1">//                 ※ 特制版功能：在检索页面中的硕士/博士论文默认下载 CAJ 文件。</span>
<span class="c1">// @include        http://*.cnki.net/*</span>
<span class="c1">// @include        http://*.cnki.net.*/*</span>
<span class="c1">// @run-at         document-idle</span>
<span class="c1">// ==/UserScript==</span>

<span class="kd">var</span> <span class="nx">allLis</span><span class="p">,</span> <span class="nx">thisLi</span><span class="p">,</span> <span class="nx">newLi</span><span class="p">,</span> <span class="nx">aPDF</span><span class="p">,</span> <span class="nx">allLinks</span><span class="p">,</span> <span class="nx">thisLink</span><span class="p">,</span> <span class="nx">pageType</span><span class="p">;</span>
<span class="nx">pageType</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="nx">allLinks</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span>
    <span class="s1">'//a[@href]'</span><span class="p">,</span>
    <span class="nb">document</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="nx">XPathResult</span><span class="p">.</span><span class="nx">UNORDERED_NODE_SNAPSHOT_TYPE</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">);</span>

<span class="nx">allLis</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span>
    <span class="s2">"//li[@class]"</span><span class="p">,</span>
    <span class="nb">document</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="nx">XPathResult</span><span class="p">.</span><span class="nx">UNORDERED_NODE_SNAPSHOT_TYPE</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">allLis</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">allLis</span><span class="p">.</span><span class="nx">snapshotLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">thisLi</span> <span class="o">=</span> <span class="nx">allLis</span><span class="p">.</span><span class="nx">snapshotItem</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisLi</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"class"</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"readol"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pageType</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">newLi</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'li'</span><span class="p">);</span>
            <span class="nx">newLi</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span><span class="s2">"pdf"</span><span class="p">);</span>
            <span class="nx">aPDF</span> <span class="o">=</span> <span class="s1">'&lt;a target="_blank" href="'</span> <span class="o">+</span>
                   <span class="nx">thisLi</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">"&amp;dflag=readonline"</span><span class="p">,</span><span class="s2">"&amp;dflag=pdfdown"</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">'"&gt;PDF下载&lt;/a&gt;'</span><span class="p">;</span>
            <span class="nx">newLi</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="nx">aPDF</span><span class="p">;</span>
            <span class="nx">thisLi</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">newLi</span><span class="p">,</span> <span class="nx">thisLi</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisLi</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"class"</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"cajNew"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pageType</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">pageType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">allLinks</span><span class="p">.</span><span class="nx">snapshotLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">thisLink</span> <span class="o">=</span> <span class="nx">allLinks</span><span class="p">.</span><span class="nx">snapshotItem</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span> <span class="o">&amp;&amp;</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"download.aspx?filename="</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"&amp;dflag"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"=CMFD"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"=CDFD"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span> <span class="o">+</span> <span class="s2">"&amp;dflag=pdfdown"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span> <span class="o">&amp;&amp;</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"download.aspx?filename="</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"&amp;dflag"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"=CMFD"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"=CDFD"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">thisLink</span><span class="p">.</span><span class="nx">href</span> <span class="o">+</span> <span class="s2">"&amp;dflag=nhdown"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>把这段代码添加到 Tampermonkey 中，再访问知网，点开一个学位论文的页面，就能从上面看到“PDF 下载”的按钮了。就像这样：</p>

<p><img src="/assets/images/cnki-pdf-download.png" alt="学位论文可以下载 PDF 格式"></p>

<h3>关于 UserScript</h3>

<p>UserScript 就是一段 JavaScript 代码，当一个页面加载完成之后，这段 JavaScript 就会自动执行，效果就和在调试工具的终端里执行 JavaScript 一样。因此，UserScript 能够访问操作 DOM 节点，能使用页面引用的所有库。</p>

<p>UserScript 通常由浏览器的插件来管理，例如 FireFox 有 Greasemonkey，Webkit/Blink 内核的浏览器则有 Tampermonkey，而且这些工具支持的 UserScript 接口相同，同样的 UserScript 在不同的管理插件下执行的效果也是一致的。</p>

<p>至于代码开头的那一段注释，其实就是这个 UserScript 的元数据，其中描述了代码的名称、版本、作者，以及作用于哪些网页等等。</p>

<blockquote>
<p><strong>注</strong>：<a href="https://wu.nerd.moe/?p=1789">这里</a>是上面这段UserScript的原始出处。</p>

<p><strong>P.S.</strong> 这段代码实现 PDF 下载的原理并不高深，只是修改了下载链接，改了一些 GET 参数。因此可以推断，CAJ 格式实际上与 PDF 非常相似，知网的服务器可以实现格式的转换。这样转出来的 PDF 是文字版，虽然没有 CAJ 中的目录，基本需求已经完全满足。</p>
</blockquote>

    </main>
</article>

<div id="disqus_thread" class="block article-comment"></div>
<script type="text/javascript">
var disqus_shortname = 'szm';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']]
    }
});
</script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    </main>
    <footer class="footer">
    <div class="wrapper">
        <p>© 2017 <a href="/about">Song Ziming</a></p>
        <p>Generated using <a href="http://jekyllrb.com/">Jekyll</a>.
            Hosted on <a href="https://www.digitalocean.com/?refcode=fa77aca48a33">DigitalOcean</a>.</p>
        <p>Blog source available on <a href="https://www.github.com/songziming/blog">Github</a>.</p>
    </div>
</footer>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73870068-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
