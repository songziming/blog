<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>VxWorks 代码分析 1</title>

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://blog.szm.me/vxworks-1/">
</head>
<body>
    <header class="header">
    <div class="wrapper">
        <div class="homelink-wrapper">
            <a href="/" class="homelink">
                <strong>Song Ziming's Blog</strong>
            </a>
        </div>
        
        <nav class="nav">
        
            <a href="/archives" class="nav-link">archives</a>
        
            <a href="/about" class="nav-link">about</a>
        
            <a href="https://github.com/songziming/blog" class="nav-link">source</a>
        
        </nav>
    </div>
</header>

    <main class="wrapper">
        <article class="article-block">
    <header class="article-header">
        <h1>VxWorks 代码分析 1</h1>
        <p class="article-meta">
            <time datetime="2017-12-02T00:00:00+08:00" itemprop="datePublished">2017-12-02</time>
            
                /
                
                    VxWorks
                
            
        </p>
    </header>
    <main class="article-content">
        <p>由于项目关系，有幸接触到了 VxWorks 的源代码，于是带着膜拜的心态开始阅读并分析其源代码，并将分析的结果记录在这里。我分析的版本是 VxWorks 6.7。</p>

<p>网上找到的资料不少是针对 VxWorks 5.x 的，和旧版比起来，VxWorks 6.x 增加了对多核硬件（SMP）的支持，并且加入了实时进程（RTP），可以开发用户态的应用程序。</p>

<h3>文件组织结构</h3>

<p>假设 VxWorks 开发套件安装在 <code>C:\WindRiver</code>，那么 VxWorks 6.7 的源代码位于 <code>C:\WindRiver\vxworks-6.7\target</code>。其中有如下子目录：</p>

<ul>
<li><code>config</code>：这个目录中包括所有的 BSP

<ul>
<li><code>comps/VxWorks</code>：包含系统默认的组件定义文件（CDF）</li>
<li><code>comps/src</code>：这个目录下包含 configlettes，也就是一些短小的配置代码</li>
</ul></li>
<li><code>h</code>：VxWorks 内核头文件

<ul>
<li><code>private</code>：私有头文件，只有 <code>src</code> 中的代码能够访问</li>
<li><code>make</code>：Makefile 片段文件，这些文件会被各个工程的 Makefile 中引用</li>
<li><code>tool</code>：包含与工具链相关的 Makefile 片段，以及链接脚本</li>
</ul></li>
<li><code>src</code>：VxWorks 内核的源文件</li>
<li><code>lib</code>：这个目录保存编译生成的内核库（单核版本）</li>
<li><code>lib_smp</code>：这个目录保存编译生成的内核库（多核版本）</li>
<li><code>usr</code>：所有用户态相关的文件都放在这里（RTP）

<ul>
<li><code>h</code>：用户态代码使用的头文件</li>
<li><code>src</code>：用户层库的源文件</li>
<li><code>lib</code>：保存编译生成的用户库</li>
</ul></li>
</ul>

<h3>内核库，用户库</h3>

<p>VxWorks 系统的编译是分两步进行的，首先是把 VxWorks 代码编译成静态链接库，称作<strong>内核库</strong>，保存在 <code>lib</code> 或 <code>lib_smp</code> 目录下。接下来是编译用户代码和 BSP 代码，并且与内核库一起链接，生成一个可执行的系统镜像。</p>

<p>内核库可以直接在 <code>src</code> 目录下运行 <code>make CPU=PENTIUM TOOL=gnu</code> 来构建，也可以在 Workbench 中创建 VSB 项目来构建。如果使用 VSB 项目，那么生成的内核库会位于 VSB 项目目录之下。后续在创建 VIP 项目时，可以选择使用 VSB 项目中的内核库，还是使用标准位置的内核库。</p>

<p>之所以将编译 VxWorks 的过程分为两步，一个原因是这可以加快 VIP 项目的构建速度，另一个原因则是用户可以在没有源代码的情况下使用 VxWorks 开发。用户可以创建 BSP 项目开发自己的版级支持包，也可以创建 VIP 项目，编写自己的内核应用程序，但是系统核心部分的代码是不变的。因此首先把系统核心部分编译成静态链接库，这样在构建 BSP 项目时就可以直接链接已经生成的库。</p>

<p>用户层的代码也类似，首先把VxWorks提供的用户层代码（例如标准库、系统库）编译成<strong>用户库</strong>，放在 <code>usr/lib</code> 中，在编译 RTP 项目时再进行链接。用户库可以通过在 <code>usr/src</code> 目录下执行 <code>make CPU=PENTIUM TOOL=gnu</code> 命令来构建。</p>

<p>内核库可以使用 VSB 中的版本，但是用户态的程序只能链接 <code>usr/lib</code> 下的静态库。</p>

<h3>组件</h3>

<p>VxWorks 是一个可定制的操作系统，在 VIP 项目中，用户可以修改 Kenrel Configuration，选择哪些组件添加到内核中。</p>

    </main>
</article>

<div id="disqus_thread" class="block article-comment"></div>
<script type="text/javascript">
var disqus_shortname = 'szm';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']]
    }
});
</script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    </main>
    <footer class="footer">
    <div class="wrapper">
        <p>© 2017 <a href="/about">Song Ziming</a></p>
        <p>Generated using <a href="http://jekyllrb.com/">Jekyll</a>.
            Hosted on <a href="https://www.digitalocean.com/?refcode=fa77aca48a33">DigitalOcean</a>.</p>
        <p>Blog source available on <a href="https://www.github.com/songziming/blog">Github</a>.</p>
    </div>
</footer>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73870068-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
