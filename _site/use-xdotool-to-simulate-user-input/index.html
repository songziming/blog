<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>使用 xdotool 模拟用户交互</title>

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://blog.szm.me/use-xdotool-to-simulate-user-input/">
</head>
<body>
    <header class="header">
    <div class="wrapper">
        <div class="homelink-wrapper">
            <a href="/" class="homelink">
                <strong>Song Ziming's Blog</strong>
            </a>
        </div>
        
        <nav class="nav">
        
            <a href="/archives" class="nav-link">archives</a>
        
            <a href="/about" class="nav-link">about</a>
        
            <a href="https://github.com/songziming/blog" class="nav-link">source</a>
        
        </nav>
    </div>
</header>

    <main class="wrapper">
        <article class="article-block">
    <header class="article-header">
        <h1>使用 xdotool 模拟用户交互</h1>
        <p class="article-meta">
            <time datetime="2015-04-16T00:00:00+08:00" itemprop="datePublished">2015-04-16</time>
            
                /
                
                    工具
                
            
        </p>
    </header>
    <main class="article-content">
        <p>命令行下，对于一些常用而重复的命令，可以使用脚本来自动化；而对于图形界面程序，则可以使用 xdotool 来模拟用户的鼠标键盘输入。xdotool 是一个命令行工具，用户可以通过命令或者脚本模拟鼠标和键盘的动作，使用命令行控制图形界面。</p>

<h3>安装</h3>

<p>通常，发行版的软件源应该包含 xdotool，例如 Debian/Ubuntu 下可以通过 <code>sudo apt-get install xdotool</code> 来安装。如果系统软件源中没有，可以到 <a href="http://www.semicomplete.com/projects/xdotool/">xdotool 官网</a>下载源代码编译安装。xdotool 的依赖项只有 Xlib，因此编译过程应该很容易。</p>

<h3>起步</h3>

<p>下面通过一个简单的例子来测试 xdotool 的功能。首先打开图形界面下的终端模拟器，将鼠标移到某个菜单之上，但是不要点击。这时输入焦点应该还在命令行窗口，鼠标位置不动，输入下面的命令：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool click 1
</code></pre></div>
<p>执行这条命灵之后，会发现鼠标悬停处的菜单神奇地打开了，就好像在那里点了左键一样。对 X11 来说，点击鼠标只是一个事件，它并不管这个事件来自鼠标、触摸板、触摸屏还是其他设备，或者是类似 xdotool 这样的软件。</p>

<p>上面的命令中，<code>click</code> 表示动作，<code>1</code> 表示鼠标左键，合法的取值有：</p>

<table><thead>
<tr>
<th style="text-align: center">编号</th>
<th style="text-align: center">含义</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center">1</td>
<td style="text-align: center">鼠标左键</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td style="text-align: center">鼠标中键</td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td style="text-align: center">鼠标右键</td>
</tr>
<tr>
<td style="text-align: center">4</td>
<td style="text-align: center">滚轮向前</td>
</tr>
<tr>
<td style="text-align: center">5</td>
<td style="text-align: center">滚轮向后</td>
</tr>
</tbody></table>

<h3>进阶</h3>

<p>下面考虑复杂一些的情况，如果用 xdotool 来完成自动化，那么需要移动指针到指定的地方。X 桌面坐标系原点位于左上角，x 轴正方向向右，y 轴正方向向下，以像素为单位。例如，本人屏幕分辨率为 1920x1080，那么左上角的坐标为 (0, 0)，右上角的坐标为 (1920, 0)。</p>

<p>假设现在需要平铺所有的窗口（我用的是 GNOME 桌面），那么需要将鼠标移到屏幕左上角点击 “Activities” 按钮。使用 xdotool 可以这样实现：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool mousemove 0 0 click 1
</code></pre></div>
<p>xdotool 支持多个命令连在一起，上面的例子中，首先将鼠标移到屏幕左上角，然后点击鼠标左键。</p>

<p><code>mousemove</code> 指令将鼠标位置移动到指定处，<code>mousemove_relative</code> 以鼠标当前位置为初始，移动相应的距离。这两条指令经常带上 <code>--sync</code> 参数，表示一定要等到 X11 确认鼠标已经移动到了目标位置，才会继续执行。</p>

<p>需要注意的是，如果坐标包含负值，必须在坐标前加上两个减号。例如命令</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool mousemove_relative -10 -10
</code></pre></div>
<p>是不能正确执行的，应该使用这种方式：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool mousemove_relative -- -10 -10
</code></pre></div>
<h3>窗口</h3>

<p>xdotool 最强大的一个功能，就是能够自动搜索窗口，确定该窗口的位置，并使用窗口的局部坐标。例如，寻找 Chrome 浏览器并激活其窗口，可以通过下面的命令实现：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool search <span class="s2">"Chrome"</span> windowactivate
</code></pre></div>
<p>这个功能需要窗口管理器的支持，xdotool 会遍历所有窗口，一旦发现标题栏内容包含指定的关键词，就返回该窗口。如果没有符合规则的窗口，那么什么也不会发生。</p>

<p>这里需要指出的是，窗口的标题栏内容和程序名称没有必然的关系。xdotool 根据标题栏内容查找窗口，而非应用程序的名字。</p>

<p>找到了目标窗口，还不能立刻对窗口中的按钮进行操作，因为窗口可能为于屏幕的任何位置。不过，我们可以将鼠标移动到窗口的左上角：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool search <span class="s2">"Chrome"</span> windowactivate --sync mousemove --window %1 0 0
</code></pre></div>
<p><code>--window X</code> 表示后面的坐标是相对窗口 X 而言的，<code>%1</code> 表示 search 操作返回的第一个窗口。</p>

<p>除了将鼠标移动到窗口的左上角，另一个方案是将窗口移动到指定的位置。例如，将 Chrome 移动到 (50, 50) 处：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool search <span class="s2">"Chrome"</span> windowactivate --sync windowmove 50 50
</code></pre></div>
<p>再进一步，还可以指定窗口的大小，例如将 Chrome 缩放到宽 640，高 480 的大小：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool search <span class="s2">"Chrome"</span> windowsize 640 480
</code></pre></div>
<h3>杂项</h3>

<h4>拖拽</h4>

<p>拖拽动作可以分解为“按下鼠标-移动鼠标-释放鼠标”的步骤，下面的代码是一个简单的例子：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool mousedown 1
sleep 0.5
xdotool mousemove_relative --sync 200 200
sleep 0.5
xdotool mouseup 1
</code></pre></div>
<h4>按键与输入</h4>

<p>与鼠标模拟相比，xdotool 的虚拟键盘要简单的多。例如，按下 F1 键只需要：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool key F1
</code></pre></div>
<p>如果需要组合键，可以使用加号连接：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool key ctrl+a
</code></pre></div>
<p>对于文本流的输入，xdotool 提供了一个 <code>type</code> 命令：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xdotool search <span class="s2">"gedit"</span> windowactivate --sync <span class="nb">type</span> <span class="s2">"hello world"</span>
</code></pre></div>
    </main>
</article>

<div id="disqus_thread" class="article-block article-comment"></div>
<script type="text/javascript">
var disqus_shortname = 'szm';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']]
    }
});
</script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    </main>
    <footer class="footer">
    <div class="wrapper">
        <p>© 2018 <a href="/about">Song Ziming</a></p>
        <p>Generated using <a href="http://jekyllrb.com/">Jekyll</a>.
            Hosted on <a href="https://www.digitalocean.com/?refcode=fa77aca48a33">DigitalOcean</a>.</p>
        <p>Blog source available on <a href="https://www.github.com/songziming/blog">Github</a>.</p>
    </div>
</footer>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73870068-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
