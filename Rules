#!/usr/bin/env ruby

layout '/**/*', :erb

compile '/notes/**/*.md' do
    folder = item.identifier.to_s.match(/^\/notes\/(.*)\.md$/)[1].split('/')
    title  = folder[-1].match(/^(\d+)-(.*)$/)[2]
    number = folder.map { |s| s.match(/^(\d+)-(.*)$/)[1] }
    filter :pandoc, from: 'markdown', to: 'html5', args: ['mathjax']
    layout '/note.*', locals: { title: title }
    write "/#{number.join('/')}_#{item[:permalink]}.html"
end

compile '/notes/**/asset/**/*' do
    match  = item.identifier.to_s.match(/^\/notes\/(.*)\/asset\/(.*)$/)
    number = match[1].split('/').map { |s| s.match(/^(\d+)-(.*)$/)[1] }
    write "/#{number.join('/')}/asset/#{match[2]}"
end

compile '/*.html' do
    filter :erb
    layout '/base.*', locals: { title: 'ZMKB' }
    write item.identifier.to_s
end

compile '/**/*' do
    write item.identifier.to_s
end
