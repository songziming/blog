title: CPUID
category: x86-64
tags:
- CPU
---

在 X86 CPU 发展过程中，不断有新的硬件特性加入，但软件如果想使用这些新特性，必须首先确定 CPU 支持这些特性。起初，软件可以通过检测标志寄存器确定 CPU 的型号，但后来 CPU 型号越来越多，型号之间的差别也越来越细化，仅仅使用 eflags 不能确定某个硬件特性的存在与否。因此英特尔引入了 CPUID。CPUID 是一个指令，可以用来查询 CPU 型号、生产商，以及缓存大小等其他硬件信息。

### CPUID 的检测

CPUID 指令是奔腾之后才引入的，因此最好首先检测一下 CPUID 是否可用，虽然目前的 CPU 基本都是奔腾以上了。检测的方法是修改 eflags 寄存器的 ID 位（第 21 位），如果 CPU 不支持 CPUID 指令，那么 ID 位是不可修改的。测试 CPUID 的汇编代码如下：

``` asm
    pushfd                      ; 保存 eflags 的原值
    pushfd                      ; eflags 压栈
    xor     dword[esp], 1 << 21 ; 反转栈顶元素 ID 位
    popfd                       ; 将栈顶元素赋给 eflags
    pushfd                      ; 新 eflags 压栈
    pop     eax                 ; 新 eflags 赋给 eax
    xor     eax, [esp]          ; 将 eax 与 栈顶存储的原 eflags 比较
    popfd                       ; 回复 eflags 原值
    and     eax, 1 << 21        ; 若 ID 位可写，则 eax 非零，若 ID 位不可写（无 CPUID），则 eax 为 0
    ret
```

这段代码不能以内联汇编的形式写在 C 程序中，因为 C 语言编译器有可能改变 eflags 的值。

### 使用

CPUID 的行为取决于 eax 寄存器的值，CPUID 返回的信息通常也在寄存器中。例如获取 CPU 生产商信息就使用 `eax=0`，返回信息是一个 12 字节的字符串，包含在 eax，ebx 和 ecx 中。

### 参考资料

- [Intel CPUID Spec](http://bochs.sourceforge.net/techspec/24161821.pdf)
- [AMD CPUID Spen](http://support.amd.com/TechDocs/25481.pdf)

