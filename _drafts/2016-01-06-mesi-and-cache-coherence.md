---
title: MESI 协议与缓存一致性
category: OS
---

现代 CPU 通常带有缓存，用于减少访问内存的开销。在目前的多核 CPU 中，L1 缓存是继承在处理器核心内部的，也就是每个处理器核心都有自己的 L1 缓存，这时缓存一致性问题就暴露出来了。

缓存一致性是指不同的核心缓存了相同内存位置的数据，一个核心对数据进行了更改，其他核心的缓存则必须更新。缓存一致性是由硬件负责的，整个过程对软件透明，因此软件开发者完全可以无视缓存一致性问题的存在。但是了解硬件处理缓存一致性的方法，可以让我们写出更好的程序。

Intel 和 AMD 使用的都是一种叫做 MESI 的协议，这是伊利诺伊州立大学提出的一种协议。

### 缓存

首先来看一下缓存的结构。最基本的缓存单元称作“行”，一行包含若干字节的数据，这些数据就是从内存中或者下一级缓存中读取出来的信息。除此之外，每一行还要记录当前的状态。状态只有两种取值，“有效”表示当前该行存储的是对应内存中的数据，“无效”表示当前行的内容是不保证的。

关于缓存的其他信息这里就不说了，可以参考 CSAPP。

### MESI 协议的缓存状态

在 MESI 协议下，缓存的转台得到了扩展，原来的两种状态变为 4 种：

- Invalid，即“无效”，这一行不包含任何有用信息
- Modified，顾名思义，表示信息缓存进来之后进行了修改。在多核环境下，一个核心的缓存记录进行了修改就会变为 Modified 状态，如果其他核心也缓存了相同地址的内存数据，那么所有其他缓存中的内容都是失效的，因为它们并不知道发生了修改。Modified 状态表示，在所有缓存的该数据的版本中，这一行是唯一有效的。
- Exclusive，同样表示这是所有副本中唯一有效的，但是缓存的内容和内存中的数据是相同的。
- Shared，表示这条缓存记录有多个副本有效，而且缓存的内容与内存的内容完全一致。

多个核心的缓存可以同时为 Shared 状态，或者一方为 Invalid 状态，其他组合均不合法。	

Modified、Exclusive、Shared、Invalid，取它们的首字母，就是这个协议的名称，MESI。四种状态可以发生切换，切换需要满足一定的条件。

现在只关心有一个核心的情况，初始缓存是空的，也就是处于 Invalid 状态。

1. 程序请求内存，CPU 发现缓存不命中，于是访问内存，并且把读取的内容放在缓存里。由于目前只是读取内存内容，缓存和内存的信息是一致的。现在要确定缓存的状态，这需要看一下其他核心的缓存。如果这个内存地址的数据存在其他的缓存拷贝，也就是已经被其他处理器缓存，那么状态就变为 Shared。如果没有其他核心缓存了这个信息，那么缓存状态就变成 Exclusive。
