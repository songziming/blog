title: MSR 寄存器
category: x86-64
tags:
- CPU
---

MSR（Model Specific Register） 是 Intel X86 系列 CPU 中的一组寄存器，包含许多 CPU 重要信息，如时钟数、本地 APIC 等。本文简要介绍了 MSR 寄存器的产生、读写方法，和一些例子。

### 历史

80386 CPU 中包含两个特殊的寄存器，`tr6` 和 `tr7`，用来测试其分页缓存 TLB。但是，英特尔在文档中说，这两个寄存器是 80386 模型特有的寄存器，在后续版本的 CPU 中可能会被移除。

到了 80486，`tr6` 和 `tr7` 被保留了下来，不仅如此，还添加了 `tr3`、`tr4` 和 `tr5` 三个寄存器，用来测试 CPU 的代码和数据缓存。同样，英特尔在文档中说明这些寄存机是 80486 特有的，可能会在后续版本中移除。

果然，奔腾处理器（俗称的 80586）发布时，这些 `trN` 寄存器都被删除了。这些寄存器只在特定的 CPU 型号中才存在，因此这些寄存器也被称作 Model Specific Register（MSR）。

也是从奔腾处理器开始，英特尔引入了两个指令，能够实现对 MSR 的读写。早期的 MSR 数量并不多，但后来数目已经超过 200 各。某些 MSR 寄存器甚至非常重要，例如切换 64 位工作模式就是通过修改 MSR 实现的。

虽然这些 MSR 理论上都是“模型特有”的，但许多已经成了 x86 系列的固有标准。

### rdmsr 和 wrmsr

`rdmsr` 和 `wrmsr` 是读取和写入 MSR 用的两个特权指令，只能在最高特权级下执行。每个 MSR 寄存器都有其唯一的 ID，在使用 `rdmsr` 和 `wrmsr` 指令读写 MSR 时，将 MSR 的 ID 保存在 `ecx` 寄存器中，大多数 MSR 寄存器都是 64 位的，值保存在 `edx:eax` 寄存器组里。

### 时钟计数器 Time Stamp Counter

CPU 内置有一个 64 位的硬件时钟计数器，这个计数器没过一个时钟周期就会增加 1。这个寄存器实现为一个 MSR，编号为 0x10，可以通过 `rdmsr` 读取。同时，CPU 还针对这个 MSR 提供了一个非特权指令 `rdtsc`，使得用户级程序也能够获取硬件时钟数值。

由于这个寄存器是随着 CPU 的时钟周期增长的，因此在 Benchmarking 方面非常有用。

### 扩展功能寄存器 EFER

EFER 全称是 Extended Feature Enable Register，编号 0xc0000080。这是一个类似 eflags 的寄存器，其中包含许多重要系统功能的控制位。例如 LME（第 8 位）控制长方式的开启，SVME（第 12 位）控制虚拟化功能。
