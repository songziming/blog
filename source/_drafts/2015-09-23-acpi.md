title: ACPI
category: OS Dev
tags:
- acpi
- power
---

ACPI 全名是高级配置和电源管理接口（Advanced Configuration and Power Management Interface），是 PC 平台上进行电源管理的标准，由英特尔、微软和东芝制定。操作系统的关机、重启功能就是通过这个接口实现的，但 ACPI 的功能不仅是管理电源，还能用来监视温度、风扇转速、电池电量，以及总线 IRQ、CPU、APIC 等。

### RSDP

ACPI 主要由两部分组成，分别用于系统启动时的初始化和运行时环境。操作系统如果想使用 ACPI，首先需要寻找 RSDP（Root System Description Pointer，根系统描述符指针），RSDP 是一个数据结构，其中包含一个指向 RSDT（Root System Description Table，根系统描述表）的指针。以下是 RSDP 的结构：

``` c
struct rsdp {
    char signature[8];
    uint8_t checksum;
    char oem_id[6];
    uint8_t revision;
    uint32_t rsdt_addr;
} __attribute__((packed));
```

对于新版的 ACPI（2.0 及以上），RSDP 中还包含一个指向 XSDT（eXtended System Description Table，扩展系统描述表）的指针。RSDT 和 XSDT 都包含一些指向其他数据结构的指针，它们最大的区别就是 XSDT 包含 64 位指针，而 RSDT 包含 32 位指针。新版的 RSDP 结构如下：

``` c
struct rsdp {
    char signature[8];
    uint8_t checksum;
    char oem_id[6];
    uint8_t revision;
    uint32_t rsdt_addr;

    uint32_t length;
    uint64_t xsdt_addr;
    uint8_t ext_checksum;
    uint8_t reserved[3];
} __attribute__((packed));
```

RSDP 可能存在于两个地方：扩展 BIOS 数据区（EBDA）的前 1KB，或 BIOS 主数据区，即地址 0xe0000 至 0xfffff。其中 EBDA 的起始地址可以从物理地址 `0x40e` 的两个字节中读取。RSDP 的 signature 字段取值为 `"RSD PTR "`，注意字符串共 8 个字符，包含两个空格，不以 `'\0'` 结尾。RSDP 的起始地址是 16 字节对齐的，因此每隔 16 字节逐一对 signature 进行比较就能找到 RSDP。

找到 RSDP 之后，根据 revision 字段为 0，表示使用 ACPI 1.0 标准，revision 为 1 说明使用 ACPI 2.0 标准，依此类推。

进行校验时，无论旧版还是新版的 RSDP，都对 1.0 版本的结构中所有字节求和，若总和为零，则说明 1.0 版本的 RSDP 合法。对于 2.0 版本的 RSDP，进行了前面的校验之后，还需要对 2.0 RSDP 结构中的剩余字节求和校验。

### RSDT 和 XSDT

接下来将涉及一大堆数据结构，ACPI 定义的数据结构有一个共同特点，就是它们都有相同的头。

``` c
struct sdt_header {
    char signature[4];
    uint32_t length;
    uint8_t revision;
    uint8_t checksum;
    char oem_id[6];
    char oem_table_id[8];
    uint32_t oem_revision;
    uint32_t creator_id;
    uint32_t creator_revision;
} __attribute__((packed));
typedef struct sdt_header sdt_header_t;
```

以下是 RSDT 和 XSDT 的定义：

```c
struct rsdt {
    sdt_header_t header;
    uint32_t sdt_addrs[0];
} __attribute__((packed));
typedef struct rsdt rsdt_t;

struct xsdt {
    sdt_header_t header;
    uint64_t sdt_addrs[0];
} __attribute__((packed));
typedef struct xsdt xsdt_t;
```

可以看出，RSDT 和 XSDT 仅有的不同就是后续字段指针位数不同。上面结构体中，成员数组长度为零并不表示没有成员，而是数组长度不固定。长度可以由下面的公式计算：

```
n = (header.length - sizeof(header)) / size;
```

其中的 `size` 取 4 或 8，取决于。

### ACPICA

ACPI 经过若干年的发展，复杂度成倍增长。以至于操作系统为了支持 ACPI 需要再写一个操作系统。Intel 有一个开源项目，叫做 ACPICA，就是为了解决这个问题而生的。

ACPICA 包含一些平台无关的 C 语言代码，将这些代码复制到 OS 中，就能让 OS 支持 ACPI。听起来很神奇，但仔细想一下，就会发现，这实际上就是把别人的代码拿过来，当成自己写的放进内核中一样。确实，只不过为了让 ACPICA 能工作起来，OS 必须实现一些系统相关的函数。
