---
title: Linux 红黑树的使用
category: 开发
tags:
- linux
- rbtree
---

Linux 内核中包含一个非常高校的红黑树实现，但是使用却不那么容易。

这个红黑树是在内核代码中的，但没有多少其他依赖关系。事实证明，只需要对源代码作一些微小的修改，就能够用在自己的程序里。

### rb_node

`rb_node` 是一个结构体，其中包含指向左右子节点的指针、指向父节点的指针和一个颜色字段。其中颜色字段使用父节点字段里没有使用的二进制位存储，这样可以压缩一些空间（内核代码就是这么精打细算）。

Linux 内核的红黑树是一个通用的数据结构，也就是说，节点内部可以存储任意类型的数据。但是 `rb_node` 中并不包含 void 指针，要使用红黑树，需要创建另一个结构体，并把 `rb_node` 作为这个结构体的第一个成员，代码如下：

``` c
typdef struct my_node {
    struct rb_node rb;
    int real_data;
} my_node_t;
```

struct 实际上就是若干连续存储的变量，因此 rb_node 的指针变量所指向的地方就是 `my_node` 对象。

### 搜索

红黑树的本质就是一颗二叉搜索树，因此搜索是红黑树最常见的任务。

Linux 并没有提供关于红黑树的高层操作，这些操作是要编程人员实现的，`rbtree.h` 中只定义了一些工具函数。这样的设计使得红黑树的使用相对难度较高，却保证了灵活和性能。
