---
title: "调度"
---

WHEEL-RTOS是一个实时系统，在调度策略上，我们就采用vxworks的设计。

### readyq_put 将一个任务添加到就绪队列

当任务状态由不可执行变为可执行（ready）时，就需要被放入就绪队列，因此这个操作是非常高频的。

任务有不同的亲和性，我们需要根据亲和性判断添加到哪个CPU的就绪队列，如果没有亲和性，就放到全局的就绪队列中。

放入就绪队列之后，有可能发生抢占，因此需要进行检查，检查新添加的任务能否抢占所在CPU的当前任务。这里面就有问题了：
- 如果任务有亲和性，只要检查对应的CPU，但是这个CPU很有可能不是当前CPU，在我们检查的过程中，目标CPU上运行的任务有可能发生了切换。
- 如果任务没有亲和性，说明可以在任何一个cpu上运行，那么就应该挑出当前优先级最低的那个CPU。还是之前的问题，我们挑出来之后，那个CPU很有可能自己进行了切换。

定义一些percpu的标志变量，例如：
- tid_current表示当前正在运行的任务
- need_resched表示可能存在更高优先级的任务，需要检查。具体的检查工作在中断返回过程中执行。